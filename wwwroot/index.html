<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Slate</title>
</head>

<body>

    <canvas id="canvas" width="1000" height="1000"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <script>

        // const leftBtn = 0
        // const lineWidth = 2
        // const color = "#FF0000"
        // let isDrawingEnable = false;

        window.addEventListener('load', (event) => {

            const hubConnection = new signalR.HubConnectionBuilder()
                .withUrl("/imageExchanging")
                .build();

            hubConnection.on("Receive", (imgData) => {


                let file = imgData.File;
                let scale = imgData.Scale;
                let left = imgData.Left;
                let top = imageData.Top

                var fileReader = new FileReader();

                fileReader.onload = () => {
                    fabric.util.loadImage(fileReader.result, (img) => {
                        var oImg = new fabric.Image(img);
                        oImg.scale(scale).set({
                            left: left,
                            top: top,
                        });
                        canvas.add(oImg);
                    });
                }

                fileReader.readAsDataURL(file);
            })

            hubConnection.start()
                .catch(function (err) {
                    return console.error(err.toString());
                });




            var canvas = new fabric.Canvas('canvas')

            const dropZone = document.body;
            //var dropZone = document.getElementById('canvas');
            if (dropZone) {
                //let hoverClassName = 'hover';

                dropZone.addEventListener("dragenter", function (e) {
                    e.preventDefault();
                    //dropZone.classList.add(hoverClassName);
                });

                dropZone.addEventListener("dragover", function (e) {
                    e.preventDefault();
                    //dropZone.classList.add(hoverClassName);
                });

                dropZone.addEventListener("dragleave", function (e) {
                    e.preventDefault();
                    //dropZone.classList.remove(hoverClassName);
                });

                dropZone.addEventListener("drop", function (e) {
                    e.preventDefault();
                    //dropZone.classList.remove(hoverClassName);

                    const files = Array.from(e.dataTransfer.files);

                    // if (files.length > 0) { // Загрзка на сервер
                    //     const data = new FormData();
                    //     for (const file of files) {
                    //         data.append('file', file);
                    //     }

                    //     fetch('/upload', {
                    //         method: 'POST',
                    //         body: data
                    //     })
                    //         .then(() => console.log("file uploaded"))
                    //         .catch(reason => console.error(reason));
                    // }

                    if (!FileReader || files.length <= 0)
                        return





                    let file = files[0]
                    let scale = 1
                    let left = 100
                    let top = 100


                    var fileReader = new FileReader();

                    fileReader.onload = () => {
                        fabric.util.loadImage(fileReader.result, (img) => {
                            var oImg = new fabric.Image(img);
                            oImg.scale(1).set({
                                left: 100,
                                top: 100,
                            });
                            canvas.add(oImg);
                        });
                    }

                    fileReader.readAsDataURL(file);

                    hubConnection.invoke("Send", { "File": file, "Scale": scale, "Left": left, "Top": top, })
                        .catch(function (err) {
                            return console.error(err.toString());
                        });
                });
            }
        })
    </script>
</body>

</html>